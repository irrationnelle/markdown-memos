# AWS EC2 고급 활용 기법 및 모범 사례

## EC2 인스턴스 선택의 기본 요소

### 구성요소

* API
* 구매옵션
* 네트워킹
* 인스턴스

### 인스턴스

* host server - hypervisor - guest 1, guest 2, guest 3
* 저기서 말하는 guest 들이 ec2 instance
* 2006 년에 M1 인스턴스 서비스를 시작함

### 인스턴스를 선택하는데 있어 기준

* c5.xlarge - 인스턴스 유형
* c: 인스턴스 패밀리
* 5: 인스턴스 세대
* xlarge: 인스턴스 크기

### 인스턴스 종류들

* 머신러닝을 지원하기 위해서는 gpu optimized 된 인스턴스를 추천
* 범용 인스턴스 : T2
  * 인스턴스 중 가장 저렴
  * 크레딧을 기반으로 버스팅
  * T2 Unlimited 를 통해 크레딧 소진 후에도 원하는 만큼 최대 성능 발휘
* M5: 최신 하이퍼 바이저 기술 기반
* C5: 보다 성능이 좋음.
* X1e: 메모리 최적화 인스턴스
* EC2 Bare Metal: 가상화되지 않은 물리적인 실제 서버

## 사용사례

* 생각보다 많은 워크로드들이 서버의 CPU 를 사용하지 않음

### T 타입 인스턴스 특성

* 가장 낮은 가격
* 버스팅 가능한 성능
* CPU 크레딧에 따라 CPU 성능 하달
  * 기준 성능보다 미달하는 워크로드가 발생하면 크레딧을 적립. 기준 성능을 넘어서는 CPU 로드가 생기면 크레딧을 소진

### 크레딧의 작동 방식

* 사진 참조
* 크레딧을 계속해서 전부 소진해서 크레딧 잔고가 바닥이 나서 base 성능으로 인스턴스가 작동하는 경우, 사용하는 워크로드에 비해 기대 인스턴스 성능이 잘못됨. 따라서 인스턴스를 업그레이드할 필요가 있음.
* T2 Unlimited 인스턴스는 향후 사용하게 될 크레딧을 미리 끌어와서 사용
  * 크레딧 소진의 시나리오를 정확히 이해하는 것이 좋다

### 인스턴스 분할 시나리오

* 큰 인스턴스 하나를 사용할 것인가, 작은 시나리오를 여러개 사용할 것인가 결정이 가능
* 같은 사용량이어도 인스턴스를 분할해서 인스턴스를 병렬적으로 auto scaling 하는 경우 54%나 비용 절감이 가능하다.

### 인스턴스 유형

* spot, on-Demand, reserved 등의 인스턴스 유형까지 변경한다면 75%로 비용 절감이 가능

## EC2 팁

### Virtual CPU, vCPU 란 무엇인가

* 일반적으로 하이퍼 스레드 코어
* vCPU 를 2 로 나눠 코어수를 계산
* https://aws.amazon.com/ec2/virtualcores/
* 하이퍼스레딩이 워크로드의 성능을 저하시키는 경우
  * 직접 하이퍼스레딩을 오프시켜서 유저가 원하는 성능을 가져갈 수 있음
* 하이퍼스레딩을 종료하면 물리적 코어와 하이퍼스레딩 코어가 1:1 대응이 되서 성능 향상이 될 수 있다

### EC2 프로세스 제어

* 유후코어와 활성코어를 조정
* C-상태와 P-상태를 제어
* 굉장히 로우한 레벨에서 이야기

### Timekeeping

* 현 세대의 인스턴스에서는 TSC 사용 가능

### Elastic Network Adapter

* 차세데 고급 네트워킹
* 배치그룹에서 25Gbps
* 새로운 오픈 소스 드라이버
* 네트워크 성능이 중요한 경우 iperf 로 테스트할 것
* R4 이후의 인스턴스들(R4, I3, G3, F1, X1, P3, C5)은 ENA 제공

### OS

* 메모리 집약적 인 웹 애플리케이션
* 많은 스레드 생성
* 메모리의 신속한 할당 해제
* RHEL6 와 RHEL7 성능 비교
  * perf 사용하여 성능 비교 가능
  * `sudo perf stat ./ebizzy -s 10`
  * 동일한 환경에서 동일한 코드를 진행했음에도 RHEL7 성능이 월등히 좋았음
* Nvme 기술이 적용된 리눅스 운영체제:
  * current amazon linux
  * ubuntu 14.04 이후
  * rhel/centos 7 이후
